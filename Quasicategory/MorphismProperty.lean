import Mathlib.CategoryTheory.SmallObject.TransfiniteCompositionLifting
import Mathlib.SetTheory.Cardinal.Order
import Mathlib.CategoryTheory.SmallObject.Basic

universe w v u

namespace CategoryTheory

variable {C : Type u} [Category.{v} C]

namespace MorphismProperty

variable (T : MorphismProperty C)

inductive Morphism {X Y : C} (p : X ‚ü∂ Y) : {A B : C} ‚Üí (A ‚ü∂ B) ‚Üí Prop
  | mk : (Morphism p) p

section Morphism

variable {X Y : C} (p : X ‚ü∂ Y)

/-- the class of a single morphism `p`. -/
def morphism : MorphismProperty C := fun _ _ i ‚Ü¶ (Morphism p) i

/-- a morphism `p` has rlp wrt a class `T` of morphisms iff every morphism in `T` has llp wrt `p`. -/
lemma morphism_rlp_iff : T.rlp p ‚Üî T ‚â§ (morphism p).llp :=
  ‚ü®fun hp _ _ _ hi _ _ _ ‚ü®‚ü© ‚Ü¶ hp _ hi, fun h _ _ i hi ‚Ü¶ h i hi _ .mk‚ü©

lemma morphism_llp_iff : T.llp p ‚Üî T ‚â§ (morphism p).rlp :=
  ‚ü®fun hp _ _ _ hi _ _ _ ‚ü®‚ü© ‚Ü¶ hp _ hi, fun h _ _ i hi ‚Ü¶ h i hi _ .mk‚ü©

lemma morphism_le_iff : morphism p ‚â§ T ‚Üî T p :=
  ‚ü®fun h ‚Ü¶ h _ .mk, fun h _ _ _ ‚ü®‚ü© ‚Ü¶ h‚ü©

end Morphism

section LiftingProperty

open Limits

variable {X Y : C} {p : X ‚ü∂ Y}

variable [HasInitial C] [InitialMonoClass C]

@[simp]
noncomputable
def _root_.CategoryTheory.HasLiftingProperty.section_of_initial_to_left
    (h : HasLiftingProperty (initial.to Y) p) : Y ‚ü∂ X :=
  (h.sq_hasLift (CommSq.mk (initial.hom_ext (initial.to X ‚â´ p) (initial.to Y ‚â´ ùüô Y)))).exists_lift.some.l

noncomputable
instance splitEpi_of_monomorphisms_rlp
    (hp : (monomorphisms C).rlp p) : SplitEpi p where
  section_ := (hp _ (initial.mono_from _ _)).section_of_initial_to_left
  id := CategoryTheory.CommSq.LiftStruct.fac_right _

end LiftingProperty

section WeaklySaturated

class WeaklySaturated : Prop where
  IsStableUnderCobaseChange : T.IsStableUnderCobaseChange
  IsStableUnderRetracts : T.IsStableUnderRetracts
  IsStableUnderCoproducts : IsStableUnderCoproducts.{w} T
  IsStableUnderTransfiniteComposition : IsStableUnderTransfiniteComposition.{w} T

instance [h : WeaklySaturated T] : T.IsStableUnderCobaseChange :=
  h.IsStableUnderCobaseChange

instance [h : WeaklySaturated T] : T.IsStableUnderRetracts :=
  h.IsStableUnderRetracts

instance [h : WeaklySaturated.{w} T] : IsStableUnderTransfiniteComposition.{w} T :=
  h.IsStableUnderTransfiniteComposition

instance [h : WeaklySaturated.{w} T] : IsStableUnderCoproducts.{w} T :=
  h.IsStableUnderCoproducts

instance llp_isWeaklySaturated : WeaklySaturated T.llp :=
  ‚ü®T.llp_isStableUnderCobaseChange, T.llp_isStableUnderRetracts, ‚ü®T.llp_isStableUnderCoproductsOfShape‚ü©, ‚ü®T.isStableUnderTransfiniteCompositionOfShape_llp‚ü©‚ü©

/-- weakly saturated classes contain all isomorphisms. -/
lemma WeaklySaturated.isomorphisms_le [WeaklySaturated T] :
    isomorphisms C ‚â§ T := fun _ _ p hp ‚Ü¶
  letI : IsIso p := hp
  WeaklySaturated.IsStableUnderCobaseChange.of_isPushout (IsPushout.of_vert_isIso ‚ü®rfl‚ü©) (ContainsIdentities.id_mem _)

open Limits in
/-- inductive type defining the weakly saturated class generated by a morphism property -/
inductive WeaklySaturatedClass (T : MorphismProperty C) : {X Y : C} ‚Üí (X ‚ü∂ Y) ‚Üí Prop
  | of ‚¶ÉX Y : C‚¶Ñ (f : X ‚ü∂ Y) (h : T f) : WeaklySaturatedClass T f
  | pushout ‚¶ÉX Y Z W : C‚¶Ñ ‚¶Éf : X ‚ü∂ Y‚¶Ñ ‚¶Ég : X ‚ü∂ Z‚¶Ñ ‚¶Éinl : Z ‚ü∂ W‚¶Ñ ‚¶Éinr : Y ‚ü∂ W‚¶Ñ (_ : IsPushout g f inl inr) : WeaklySaturatedClass T f ‚Üí WeaklySaturatedClass T inl
  | retract ‚¶ÉX Y Z W : C‚¶Ñ ‚¶Éf : X ‚ü∂ Y‚¶Ñ ‚¶Ég : Z ‚ü∂ W‚¶Ñ (_ : RetractArrow f g) : WeaklySaturatedClass T g ‚Üí WeaklySaturatedClass T f
  | coproduct (J : Type w) (X‚ÇÅ X‚ÇÇ : (Discrete J) ‚•§ C) (c‚ÇÅ : Cocone X‚ÇÅ) (c‚ÇÇ : Cocone X‚ÇÇ) (h‚ÇÅ : IsColimit c‚ÇÅ) (_ : IsColimit c‚ÇÇ)
      (f : X‚ÇÅ ‚ü∂ X‚ÇÇ) : (_ : ‚àÄ (j : (Discrete J)), (WeaklySaturatedClass T) (f.app j)) ‚Üí WeaklySaturatedClass T (h‚ÇÅ.desc (Cocone.mk _ (f ‚â´ c‚ÇÇ.Œπ)))
  | transfinite (J : Type w) [LinearOrder J] [SuccOrder J] [OrderBot J] [WellFoundedLT J]
      {X Y : C} (f : X ‚ü∂ Y) (hf : CategoryTheory.TransfiniteCompositionOfShape J f) :
        (‚àÄ (j : J), (hj : ¬¨IsMax j) ‚Üí WeaklySaturatedClass T (hf.F.map (homOfLE (Order.le_succ j)))) ‚Üí WeaklySaturatedClass T f

/-- the weakly saturated class generated by a morphism property. -/
def saturation : MorphismProperty C := fun _ _ f ‚Ü¶ WeaklySaturatedClass.{w} T f

-- do galois connection, galois insertion

instance saturation_isWeaklySaturated (T : MorphismProperty C) : WeaklySaturated.{w} (saturation.{w} T) where
  IsStableUnderCobaseChange := ‚ü®fun h hf ‚Ü¶ .pushout h hf‚ü©
  IsStableUnderRetracts := ‚ü®fun h hf ‚Ü¶ .retract h hf‚ü©
  IsStableUnderCoproducts := {
    isStableUnderCoproductsOfShape := fun J _ _ _ _ _ h‚ÇÇ f hf ‚Ü¶
      .coproduct J _ _ _ _ _ h‚ÇÇ f hf }
  IsStableUnderTransfiniteComposition := {
    isStableUnderTransfiniteCompositionOfShape := fun J _ _ _ _ ‚Ü¶
      ‚ü®fun _ _ f hf ‚Ü¶ .transfinite J f _ hf.some.map_mem‚ü© }

lemma le_saturation : T ‚â§ T.saturation := .of

lemma WeaklySaturated.le_iff (S : MorphismProperty C) [WeaklySaturated.{w} S] : T ‚â§ S ‚Üî (saturation.{w} T) ‚â§ S := by
  constructor
  ¬∑ intro h _ _ f hf
    induction hf with
    | of f hf => exact h _ hf
    | pushout h _ hf => exact WeaklySaturated.IsStableUnderCobaseChange.of_isPushout h hf
    | retract h _ hf => exact WeaklySaturated.IsStableUnderRetracts.of_retract h hf
    | coproduct J X‚ÇÅ X‚ÇÇ c‚ÇÅ c‚ÇÇ h‚ÇÅ h‚ÇÇ f hf hs =>
      exact (WeaklySaturated.IsStableUnderCoproducts.isStableUnderCoproductsOfShape J).colimitsOfShape_le _ ‚ü®X‚ÇÅ, X‚ÇÇ, c‚ÇÅ, c‚ÇÇ, h‚ÇÅ, h‚ÇÇ, f, hs‚ü©
    | transfinite J f hF h' h'' =>
      exact (WeaklySaturated.IsStableUnderTransfiniteComposition.isStableUnderTransfiniteCompositionOfShape J).le _ ‚ü®hF, h''‚ü©
  ¬∑ exact T.le_saturation.trans

lemma llp_rlp_eq_saturation {T : MorphismProperty C} [HasSmallObjectArgument.{w} T] :
    T.rlp.llp = saturation.{w} T := by
  apply le_antisymm
  ¬∑ rw [llp_rlp_of_hasSmallObjectArgument, retracts_le_iff,
      transfiniteCompositions_le_iff, pushouts_le_iff, coproducts_le_iff]
    exact le_saturation _
  ¬∑ rw [‚Üê WeaklySaturated.le_iff]
    exact T.le_llp_rlp

end WeaklySaturated

end MorphismProperty

end CategoryTheory
