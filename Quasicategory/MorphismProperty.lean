import Quasicategory.KInjective.Lifting
import Quasicategory.Lifting.Basic

/-!

Defines `WeaklySaturated`.

-/

universe w v u

namespace CategoryTheory

variable {C : Type u} [Category.{v} C]

namespace MorphismProperty

inductive Morphism {A B : C} (p : A ‚ü∂ B) : {X Y : C} ‚Üí (X ‚ü∂ Y) ‚Üí Prop
  | mk : (Morphism p) p

/-- the class of a single morphism `p`. -/
def MorphismClass {X Y : C} (p : X ‚ü∂ Y) : MorphismProperty C := fun _ _ i ‚Ü¶ (Morphism p) i

/-- a morphism `p` has rlp wrt a class `T` of morphisms iff every morphism in `T` has llp wrt `p`. -/
lemma class_rlp_iff_llp_morphism (T : MorphismProperty C) {X Y : C} (p : X ‚ü∂ Y) : T.rlp p ‚Üî
    ‚àÄ {A B} (i : A ‚ü∂ B) (_ : T i), (MorphismClass p).llp i := by
  refine ‚ü®fun hp _ _ _ hi _ _ _ h ‚Ü¶ by induction h; exact hp hi, fun h _ _ i hi ‚Ü¶ h i hi .mk‚ü©

/-- a morphism `p` has llp wrt a class `T` of morphisms iff every morphism in `T` has rlp wrt `p`. -/
lemma class_llp_iff_rlp_morphism (T : MorphismProperty C) {X Y : C} (p : X ‚ü∂ Y) : T.llp p ‚Üî
    ‚àÄ {A B} (i : A ‚ü∂ B) (_ : T i), (MorphismClass p).rlp i := by
  refine ‚ü®fun hp _ _ _ hi _ _ _ h ‚Ü¶ by induction h; exact hp hi, fun h _ _ i hi ‚Ü¶ h i hi .mk‚ü©

instance llp.IsStableUnderTransfiniteComposition {T : MorphismProperty C} :
    T.llp.IsStableUnderTransfiniteComposition := T.llpWith_comp

class WeaklySaturated (P : MorphismProperty C) : Prop where
  IsStableUnderCobaseChange : P.IsStableUnderCobaseChange
  IsStableUnderRetracts : P.IsStableUnderRetracts
  IsStableUnderTransfiniteComposition : IsStableUnderTransfiniteComposition.{w} P

instance llp.WeaklySaturated (T : MorphismProperty C) : WeaklySaturated T.llp :=
  ‚ü®llp.IsStableUnderCobaseChange, llp.IsStableUnderRetracts, llp.IsStableUnderTransfiniteComposition‚ü©

/-- weakly saturated classes contain all isomorphisms. -/
lemma WeaklySaturated_contains_iso (T : MorphismProperty C) [hT: WeaklySaturated T] (p : X ‚ü∂ Y) :
    (isomorphisms C) p ‚Üí T p := fun hp ‚Ü¶
  letI : IsIso p := hp
  hT.IsStableUnderCobaseChange.of_isPushout (IsPushout.of_vert_isIso ‚ü®rfl‚ü©) (hT.IsStableUnderTransfiniteComposition.id_mem X)

-- inductive type defining the weakly saturated class generated by a morphism property
inductive WeaklySaturatedOf (T : MorphismProperty C) : {X Y : C} ‚Üí (X ‚ü∂ Y) ‚Üí Prop
  | of ‚¶ÉX Y : C‚¶Ñ (f : X ‚ü∂ Y) (h : T f) : WeaklySaturatedOf T f
  | pushout ‚¶ÉX Y Z W : C‚¶Ñ ‚¶Éf : X ‚ü∂ Y‚¶Ñ ‚¶Ég : X ‚ü∂ Z‚¶Ñ ‚¶Éinl : Z ‚ü∂ W‚¶Ñ ‚¶Éinr : Y ‚ü∂ W‚¶Ñ (_ : IsPushout g f inl inr) : WeaklySaturatedOf T f ‚Üí WeaklySaturatedOf T inl
  | retract ‚¶ÉX Y Z W : C‚¶Ñ ‚¶Éf : X ‚ü∂ Y‚¶Ñ ‚¶Ég : Z ‚ü∂ W‚¶Ñ (_ : RetractArrow f g) : WeaklySaturatedOf T g ‚Üí WeaklySaturatedOf T f
  | id_mem (X : C) : WeaklySaturatedOf T (ùüô X)
  | comp_mem {X Y Z} (f : X ‚ü∂ Y) (g : Y ‚ü∂ Z) : WeaklySaturatedOf T f ‚Üí WeaklySaturatedOf T g ‚Üí WeaklySaturatedOf T (f ‚â´ g)
  | transfinite (Œ≤ : Type w) [LinearOrder Œ≤] [IsWellOrder Œ≤ (¬∑ < ¬∑)] [OrderBot Œ≤]
    (F : Œ≤ ‚•§ C) (hF : F.WellOrderContinuous) (c : Limits.Cocone F) (hc : Limits.IsColimit c) :
      (‚àÄ (a : Œ≤) (_ : a < wellOrderSucc a), T.WeaklySaturatedOf (F.map (homOfLE (self_le_wellOrderSucc a)))) ‚Üí T.WeaklySaturatedOf (c.Œπ.app ‚ä•)

/-- the weakly saturated class generated by a morphism property. -/
def WeaklySaturatedClassOf (T : MorphismProperty C) : MorphismProperty C := fun _ _ f ‚Ü¶ WeaklySaturatedOf.{w} T f

-- do galois connection, galois insertion

instance of_is (T : MorphismProperty C) : WeaklySaturated.{w} (WeaklySaturatedClassOf.{w} T) where
  IsStableUnderCobaseChange := ‚ü®fun h hf ‚Ü¶ .pushout h hf‚ü©
  IsStableUnderRetracts := ‚ü®fun h hf ‚Ü¶ .retract h hf‚ü©
  IsStableUnderTransfiniteComposition := {
    id_mem := .id_mem
    comp_mem := .comp_mem
    isStableUnderTransfiniteCompositionOfShape := fun Œ≤ ‚Ü¶ {
      condition := fun F hF h c hc ‚Ü¶ .transfinite Œ≤ F hF c hc h} }

lemma le_WeaklySaturatedClassOf (T : MorphismProperty C) : T ‚â§ WeaklySaturatedClassOf T := .of

/-- if S is any other wsc containing T, then it contains the class generated by T. -/
lemma minimalWeaklySaturated (S T : MorphismProperty C) (h : T ‚â§ S) : WeaklySaturated.{w} S ‚Üí (WeaklySaturatedClassOf.{w} T) ‚â§ S := by
  intro hS X Y f hf
  induction hf with
  | of f hf => exact h _ hf
  | pushout h _ hf => exact hS.IsStableUnderCobaseChange.of_isPushout h hf
  | retract h _ hf => exact hS.IsStableUnderRetracts.of_retract h hf
  | id_mem => exact hS.IsStableUnderTransfiniteComposition.id_mem _
  | comp_mem f g _ _ hf hg => exact hS.IsStableUnderTransfiniteComposition.comp_mem f g hf hg
  | transfinite Œ≤ F hF c hc _ h' =>
    exact (hS.IsStableUnderTransfiniteComposition.isStableUnderTransfiniteCompositionOfShape Œ≤).condition F h' c hc

end MorphismProperty

end CategoryTheory
